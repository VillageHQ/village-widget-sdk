<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Village Token Auth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        .test-box {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Village Token Authorization Test</h1>
    
    <div class="test-box">
        <h3>1. Initialize SDK</h3>
        <input type="text" id="partnerKey" placeholder="Partner Key" value="test-partner-key">
        <br>
        <button onclick="initSDK()">Initialize Village SDK</button>
        <div id="initResult" class="log"></div>
    </div>

    <div class="test-box">
        <h3>2. Test Token Authorization</h3>
        <input type="text" id="testToken" placeholder="Test Token (e.g., jwt.token.here)" value="test_token_123456789012345">
        <br>
        <input type="text" id="domain" placeholder="Domain (optional)" value="">
        <br>
        <button onclick="testTokenAuth()">Authorize with Token</button>
        <div id="tokenResult" class="log"></div>
    </div>

    <div class="test-box">
        <h3>3. Test Legacy Authorization (should still work)</h3>
        <input type="text" id="userRef" placeholder="User Reference" value="user123">
        <br>
        <button onclick="testLegacyAuth()">Legacy Authorize</button>
        <div id="legacyResult" class="log"></div>
    </div>

    <!-- Load the SDK -->
    <script>
        // Village SDK loader (using local development build)
        (function(){
            var w=window;
            var d=document;
            var v=w.Village||{};
            v.q=v.q||[];
            v._call=function(m,a){v.q.push([m,a])};
            v.init=function(){v._call("init",arguments)};
            v.authorize=function(){v._call("authorize",arguments)};
            w.Village=v;
            
            // Load development build
            var s=d.createElement("script");
            s.type="module";
            s.src="../dist/dev/village-widget.js";
            s.onload = function() {
                log('initResult', 'SDK loaded successfully');
            };
            s.onerror = function() {
                log('initResult', 'Failed to load SDK', 'error');
            };
            d.head.appendChild(s);
        })();
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            const formattedMessage = `[${timestamp}] ${message}\n`;
            
            element.innerHTML += `<span class="${className}">${formattedMessage}</span>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function initSDK() {
            clearLog('initResult');
            const partnerKey = document.getElementById('partnerKey').value;
            
            if (!partnerKey) {
                log('initResult', 'Please enter a partner key', 'error');
                return;
            }
            
            try {
                log('initResult', `Initializing SDK with partner key: ${partnerKey}`);
                
                Village.init(partnerKey);
                
                // Listen for events
                Village.on('widgetReady', (data) => {
                    log('initResult', `Widget ready event: ${JSON.stringify(data)}`, 'success');
                });
                
                Village.on('oauthSuccess', (data) => {
                    log('initResult', `OAuth success event: ${JSON.stringify(data)}`, 'success');
                });
                
                log('initResult', 'SDK initialization called', 'success');
            } catch (error) {
                log('initResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testTokenAuth() {
            clearLog('tokenResult');
            const token = document.getElementById('testToken').value;
            const domain = document.getElementById('domain').value;
            
            if (!token) {
                log('tokenResult', 'Please enter a test token', 'error');
                return;
            }
            
            try {
                log('tokenResult', `Testing token authorization...`);
                log('tokenResult', `Token: ${token.substring(0, 20)}...`);
                log('tokenResult', `Domain: ${domain || 'none'}`);
                
                const result = await Village.authorize(token, domain);
                
                log('tokenResult', `Authorization result: ${JSON.stringify(result, null, 2)}`, 
                    result.ok ? 'success' : 'error');
                
            } catch (error) {
                log('tokenResult', `Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testLegacyAuth() {
            clearLog('legacyResult');
            const userRef = document.getElementById('userRef').value;
            
            if (!userRef) {
                log('legacyResult', 'Please enter a user reference', 'error');
                return;
            }
            
            try {
                log('legacyResult', `Testing legacy authorization with user reference: ${userRef}`);
                
                const result = await Village.authorize(userRef);
                
                log('legacyResult', `Legacy authorization completed`, 'success');
                
            } catch (error) {
                log('legacyResult', `Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Auto-initialize on page load for testing
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.Village) {
                    log('initResult', 'Village SDK is available');
                }
            }, 1000);
        });
    </script>
</body>
</html>